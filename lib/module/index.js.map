{"version":3,"names":["Platform","NativeModules","SafeAreaView","View","FlatList","React","useEffect","useRef","useCallback","BBBN_SystemBroadcastPicker","WebView","handleWebviewMessage","onScreenShareLocalIceCandidate","onScreenShareSignalingStateChange","onBroadcastFinished","data","instances","renderPlatformSpecificComponents","select","ios","createElement","android","BigBlueButtonTablet","url","style","onError","onSuccess","setCallState","onShouldStartLoadWithRequest","injectedJavaScript","onNavigationStateChange","onOpenWindow","renderTabItem","currentTab","tabsData","webViewRef","thisInstanceId","TARGET_SCALE","zoomOutBeforeLoad","autoFitAfterLoad","logPrefix","substring","console","log","listeners","push","setupListener","forEach","listener","index","remove","OS","BBBN_ScreenShareService","handleBackPress","renderItem","item","flex","length","flexDirection","horizontal","keyExtractor","id","toString","initialNumToRender","getItemLayout","_","offset","ref","source","uri","marginTop","contentMode","applicationNameForUserAgent","allowsInlineMediaPlayback","javaScriptEnabled","mediaCapturePermissionGrantType","scrollEnabled","bounces","nestedScrollEnabled","overScrollMode","injectedJavaScriptBeforeContentLoaded","onMessage","msg","onLoadEnd","content","nativeEvent","code"],"sources":["index.tsx"],"sourcesContent":["import {\n  EmitterSubscription,\n  Platform,\n  ViewStyle,\n  NativeModules,\n  SafeAreaView,\n  View,\n  FlatList,\n} from 'react-native';\nimport React, { useEffect, useRef, useCallback } from 'react';\nimport BBBN_SystemBroadcastPicker from './native-components/BBBN_SystemBroadcastPicker';\nimport { WebView } from 'react-native-webview';\nimport { handleWebviewMessage } from './webview/message-handler';\nimport * as onScreenShareLocalIceCandidate from './events/onScreenShareLocalIceCandidate';\nimport * as onScreenShareSignalingStateChange from './events/onScreenShareSignalingStateChange';\nimport * as onBroadcastFinished from './events/onBroadcastFinished';\n\ntype BigBlueButtonTabletSdkProps = {\n  url: string;\n  style: ViewStyle;\n  onError?: (content: any) => void;\n  onSuccess?: (content: any) => void;\n  setCallState?: any;\n  onShouldStartLoadWithRequest?: (navState: any) => boolean;\n  injectedJavaScript?: string;\n  onNavigationStateChange?: (navState: any) => void;\n  onOpenWindow?: (event: any) => void;\n  renderTabItem?: ({\n    item,\n  }: {\n    item: { id: number; url: string };\n  }) => React.ReactElement | null;\n  currentTab?: any;\n  tabsData?: any;\n};\n\nconst data = {\n  instances: 0,\n};\n\nconst renderPlatformSpecificComponents = () =>\n  Platform.select({\n    ios: <BBBN_SystemBroadcastPicker />,\n    android: null,\n  });\n\nexport const BigBlueButtonTablet = ({\n  url,\n  style,\n  onError,\n  onSuccess,\n  setCallState,\n  onShouldStartLoadWithRequest,\n  injectedJavaScript,\n  onNavigationStateChange,\n  onOpenWindow,\n  renderTabItem,\n  currentTab,\n  tabsData,\n}: BigBlueButtonTabletSdkProps) => {\n  const webViewRef = useRef<WebView>(null);\n  const thisInstanceId = ++data.instances;\n  const TARGET_SCALE = 0.85;\n  const zoomOutBeforeLoad = `\n  (function(){\n    try {\n      var s=${TARGET_SCALE};\n      var meta = document.querySelector('meta[name=\"viewport\"]');\n      if (!meta) {\n        meta = document.createElement('meta');\n        meta.name = 'viewport';\n        document.head.appendChild(meta);\n      }\n      // Set an initial zoom-out, allow pinch-zoom afterwards\n      meta.content = 'width=device-width, initial-scale=' + s + ', minimum-scale=0.5, maximum-scale=3, user-scalable=yes, viewport-fit=cover';\n      document.documentElement.style.overflowY = 'auto';\n      document.body.style.overflowY = 'auto';\n      document.documentElement.style.height = 'auto';\n      document.body.style.height = 'auto';\n    } catch(e) {}\n  })();\n  true;\n  `;\n\n  const autoFitAfterLoad = `\n(function(){\n  try {\n    var s=${TARGET_SCALE};\n    var floor = 0.75;   // don't go below 75%\n    var step  = 0.05;   // shrink by 5% per pass\n    function setViewportScale(x){\n      var m = document.querySelector('meta[name=\"viewport\"]');\n      if (!m) return;\n      m.content = 'width=device-width, initial-scale=' + x + ', minimum-scale=0.5, maximum-scale=3, user-scalable=yes, viewport-fit=cover';\n    }\n    function applyTransformFallback(x){\n      // Final fallback: visually scale everything and widen layout to avoid cropping\n      var html = document.documentElement, body = document.body;\n      html.style.transformOrigin = 'top left';\n      html.style.transform = 'scale(' + x + ')';\n      html.style.width = (100/x) + 'vw';\n      body.style.width = (100/x) + 'vw';\n      html.style.height = 'auto';\n      body.style.height = 'auto';\n      // ensure nothing hides under a footer\n      body.style.paddingBottom = '12px';\n    }\n    function fits(){\n      var H = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);\n      var C = Math.max(document.documentElement.clientHeight, window.innerHeight||0);\n      return H <= C + 2; // allow tiny rounding\n    }\n    function tryFit(){\n      if (fits()) return;\n      if (s > floor) {\n        s = Math.max(floor, s - step);\n        setViewportScale(s);\n        setTimeout(tryFit, 120);\n      } else {\n        // Still taller? Force visual scale.\n        applyTransformFallback(s);\n      }\n    }\n    // kick after layout stabilizes\n    setTimeout(tryFit, 120);\n  } catch(e){}\n})();\ntrue;\n`;\n\n  useEffect(() => {\n    const logPrefix = `[${thisInstanceId}] - ${url.substring(8, 16)}`;\n\n    console.log(`${logPrefix} - addingListeners`);\n    const listeners: EmitterSubscription[] = [];\n    listeners.push(onScreenShareLocalIceCandidate.setupListener(webViewRef));\n    listeners.push(onScreenShareSignalingStateChange.setupListener(webViewRef));\n    listeners.push(onBroadcastFinished.setupListener(webViewRef));\n\n    return () => {\n      console.log(`${logPrefix} - Removing listeners`);\n\n      listeners.forEach((listener, index) => {\n        console.log(`${logPrefix} - Removing listener ${index}`);\n        listener.remove();\n      });\n    };\n  }, [webViewRef, thisInstanceId, url]);\n\n  useEffect(() => {\n    return () => {\n      if (Platform.OS === 'android') {\n        NativeModules.BBBN_ScreenShareService.handleBackPress();\n      }\n    };\n  }, []);\n  const renderItem = useCallback(\n    ({ item }: { item: { id: number; url: string } }) => {\n      if (renderTabItem) {\n        return renderTabItem({ item });\n      }\n      return null;\n    },\n    [renderTabItem]\n  );\n\n  return (\n    <SafeAreaView style={{ flex: 1 }}>\n      {tabsData?.length > 1 && (\n        <View style={{ flexDirection: 'row' }}>\n          <FlatList\n            horizontal\n            data={tabsData}\n            renderItem={renderItem}\n            keyExtractor={(item) => item.id.toString()}\n            initialNumToRender={tabsData.length}\n            getItemLayout={(_, index) => ({\n              length: 100,\n              offset: 100 * index,\n              index,\n            })}\n          />\n        </View>\n      )}\n      <View style={{ flex: 1 }}>\n        {renderPlatformSpecificComponents()}\n\n        <WebView\n          ref={webViewRef}\n          source={{ uri: currentTab?.url || url }}\n          style={{ ...style, flex: 1, marginTop: 0 }}\n          contentMode=\"mobile\"\n          applicationNameForUserAgent=\"BigBlueButton-Tablet\"\n          allowsInlineMediaPlayback\n          javaScriptEnabled\n          mediaCapturePermissionGrantType=\"grant\"\n          scrollEnabled\n          bounces\n          // automaticallyAdjustContentInsets={false}\n          // contentInsetAdjustmentBehavior=\"never\"\n          nestedScrollEnabled\n          overScrollMode=\"always\"\n          // setSupportMultipleWindows={false}\n          onOpenWindow={onOpenWindow}\n          injectedJavaScriptBeforeContentLoaded={zoomOutBeforeLoad}\n          injectedJavaScript={autoFitAfterLoad && injectedJavaScript}\n          onMessage={(msg) =>\n            handleWebviewMessage(0, webViewRef, msg, setCallState)\n          }\n          onShouldStartLoadWithRequest={onShouldStartLoadWithRequest}\n          onNavigationStateChange={onNavigationStateChange}\n          onLoadEnd={(content: any) => {\n            if (typeof content.nativeEvent.code !== 'undefined') {\n              onError?.(content);\n            } else {\n              onSuccess?.(content);\n            }\n          }}\n        />\n      </View>\n    </SafeAreaView>\n  );\n};\n"],"mappings":"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","ignoreList":[]}